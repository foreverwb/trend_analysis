

## 🎯 完整的数据采集与触发流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        数据采集完整流程                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  每个 ETF 的完整数据 = ETF自身数据 + 持仓成分股数据                      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  例: XLK 的完整评分需要:                                         │   │
│  │                                                                  │   │
│  │  1️⃣ XLK 自身数据                                                │   │
│  │     ├── Finviz: Beta, ATR, SMA50, SMA200, RSI, Price           │   │
│  │     ├── MarketChameleon: IV30, HV20, IVR, Put/Call 等          │   │
│  │     ├── IBKR: 实时价格、历史K线 → 计算相对动量、趋势质量         │   │
│  │     └── Futu: 期权链OI → 计算 PositioningScore, TermScore       │   │
│  │                                                                  │   │
│  │  2️⃣ XLK 持仓成分股 Top N (覆盖70%+权重)                         │   │
│  │     ├── Finviz: 各成分股的技术指标 → 计算广度 (% > 50MA/200MA)  │   │
│  │     ├── MarketChameleon: 各成分股期权数据 → 计算期权确认分数     │   │
│  │     ├── IBKR: (可选) 各成分股实时价格                           │   │
│  │     └── Futu: (可选) 各成分股期权OI                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📐 产品交互流程设计

### 整体工作流

```
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐        │
│   │ Step 1  │ ──▶  │ Step 2  │ ──▶  │ Step 3  │ ──▶  │ Step 4  │        │
│   │导入ETF  │      │获取ETF  │      │导入持仓 │      │获取持仓 │        │
│   │静态数据 │      │实时数据 │      │静态数据 │      │实时数据 │        │
│   │(Finviz/ │      │(IBKR/   │      │(Finviz/ │      │(IBKR/   │        │
│   │ MC)     │      │ Futu)   │      │ MC)     │      │ Futu)   │        │
│   └─────────┘      └─────────┘      └─────────┘      └─────────┘        │
│        │                │                │                │              │
│        ▼                ▼                ▼                ▼              │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     计算 ETF 综合评分                            │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │   │
│   │  │相对动量   │  │趋势质量   │  │广度评分   │  │期权确认   │        │   │
│   │  │(ETF自身) │  │(ETF自身) │  │(持仓数据) │  │(ETF+持仓)│        │   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 触发时机设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│  📊 数据导入触发逻辑                                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  场景1: 导入 ETF 自身数据 (如导入 XLK 的 Finviz/MC)                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ✅ 导入成功: XLK 的 Finviz 数据                                 │   │
│  │                                                                  │   │
│  │  系统检测: XLK 缺少 IBKR/Futu 实时数据                           │   │
│  │                                                                  │   │
│  │  ┌────────────────────────────────────────────────────────────┐ │   │
│  │  │  🚀 获取 XLK 的 IBKR/Futu 数据?                            │ │   │
│  │  │                                                            │ │   │
│  │  │  [获取实时数据]  [稍后]                                     │ │   │
│  │  └────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  场景2: 导入 ETF 持仓成分股数据 (如导入 XLK 持仓的 Finviz/MC)           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ✅ 导入成功: XLK 持仓 65 只标的的 Finviz 数据                   │   │
│  │                                                                  │   │
│  │  系统分析:                                                       │   │
│  │  ├── Top 20 覆盖权重: 82.3% ✅ (超过70%阈值)                    │   │
│  │  ├── Top 15 覆盖权重: 71.5% ✅                                  │   │
│  │  └── Top 10 覆盖权重: 58.2% ❌ (不足70%)                        │   │
│  │                                                                  │   │
│  │  ┌────────────────────────────────────────────────────────────┐ │   │
│  │  │  建议: 对 Top 20 获取 IBKR/Futu 数据 (覆盖 82.3% 权重)     │ │   │
│  │  │                                                            │ │   │
│  │  │  Top N 选择: [10] [15] [20 ✓] [25] [30] [自定义]           │ │   │
│  │  │                                                            │ │   │
│  │  │  [获取 Top 20 实时数据]  [仅更新广度评分]  [稍后]           │ │   │
│  │  └────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🖥️ UI 设计草图

### 数据配置中心 - 改进版

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📊 数据配置中心                                                            │
│  ───────────────────────────────────────────────────────────────────────── │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  🎯 市场状态锚 (SPY / QQQ)                              [一键刷新全部] │ │
│  │  ─────────────────────────────────────────────────────────────────── │ │
│  │                                                                       │ │
│  │  ┌──────┬─────────────────────────────────┬─────────────────────────┐│ │
│  │  │      │        ETF 自身数据              │      判定结果           ││ │
│  │  │Symbol├───────┬───────┬───────┬────────┼─────────────────────────┤│ │
│  │  │      │Finviz │M.Cham │ IBKR  │ Futu   │                         ││ │
│  │  ├──────┼───────┼───────┼───────┼────────┼─────────────────────────┤│ │
│  │  │ SPY  │  ✅   │  ✅   │  ✅   │  ✅    │ 价格动量: +2.3% (20D)   ││ │
│  │  │ QQQ  │  ✅   │  ✅   │  ✅   │  ✅    │ 价格动量: +3.1% (20D)   ││ │
│  │  └──────┴───────┴───────┴───────┴────────┴─────────────────────────┘│ │
│  │                                                                       │ │
│  │  📈 市场环境: 🟢 Risk-On (A档) ─── 可满火力操作                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  📊 板块 ETF (11个)                               [批量获取实时数据]  │ │
│  │  ─────────────────────────────────────────────────────────────────── │ │
│  │                                                                       │ │
│  │  ┌──────┬──────────────────────┬──────────────────────┬──────┬─────┐│ │
│  │  │      │     ETF 自身数据     │    持仓数据 (Top N)   │      │     ││ │
│  │  │Symbol├────┬────┬────┬──────┼────┬────┬────┬───────┤ 综合 │ 操作││ │
│  │  │      │ FV │ MC │IBKR│ Futu │ FV │ MC │IBKR│ Futu  │ 评分 │     ││ │
│  │  ├──────┼────┼────┼────┼──────┼────┼────┼────┼───────┼──────┼─────┤│ │
│  │  │ XLK  │ ✅ │ ✅ │ ✅ │ ✅   │ ✅ │ ✅ │ ✅ │ ✅    │  85  │[下钻]││ │
│  │  │ XLE  │ ✅ │ ✅ │ ✅ │ ✅   │ ✅ │ ✅ │ ❌ │ ❌    │  78  │[获取]││ │
│  │  │ XLF  │ ✅ │ ✅ │ ❌ │ ❌   │ ✅ │ ❌ │ ❌ │ ❌    │  --  │[获取]││ │
│  │  │ XLY  │ ❌ │ ❌ │ ❌ │ ❌   │ ❌ │ ❌ │ ❌ │ ❌    │  --  │[导入]││ │
│  │  │ ...  │    │    │    │      │    │    │    │       │      │     ││ │
│  │  └──────┴────┴────┴────┴──────┴────┴────┴────┴───────┴──────┴─────┘│ │
│  │                                                                       │ │
│  │  Top N 配置: 板块ETF默认 [Top 20 ▼] (覆盖 ~80% 权重)                  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  🔬 行业 ETF - 用户已选择下钻                        [添加行业ETF]    │ │
│  │  ─────────────────────────────────────────────────────────────────── │ │
│  │                                                                       │ │
│  │  当前下钻: XLK (科技板块)                                             │ │
│  │                                                                       │ │
│  │  ┌──────┬───────────┬────────────────────┬────────────────────┬─────┐│ │
│  │  │      │           │   ETF 自身数据     │  持仓数据 (Top N)  │     ││ │
│  │  │Symbol│ 名称/类型 ├────┬────┬────┬────┼────┬────┬────┬────┤ 操作││ │
│  │  │      │           │ FV │ MC │IBKR│Futu│ FV │ MC │IBKR│Futu│     ││ │
│  │  ├──────┼───────────┼────┼────┼────┼────┼────┼────┼────┼────┼─────┤│ │
│  │  │ SOXX │ 半导体-锚 │ ✅ │ ✅ │ ✅ │ ✅ │ ✅ │ ✅ │ ✅ │ ✅ │ 完备 ││ │
│  │  │ SMH  │ 半导体-攻 │ ✅ │ ✅ │ ❌ │ ❌ │ ✅ │ ❌ │ ❌ │ ❌ │[获取]││ │
│  │  │ IGV  │ 软件      │ ❌ │ ❌ │ ❌ │ ❌ │ ❌ │ ❌ │ ❌ │ ❌ │[导入]││ │
│  │  └──────┴───────────┴────┴────┴────┴────┴────┴────┴────┴────┴─────┘│ │
│  │                                                                       │ │
│  │  Top N 配置: 行业ETF默认 [Top 15 ▼] (覆盖 ~85% 权重)                  │ │
│  │                                                                       │ │
│  │  双锚判定: SOXX ✅ 完备 + SMH ⏳ 待补充 → 建议先完成 SMH 数据         │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### ETF 详情面板 (点击"下钻"或"获取"后展开)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 XLK 详情                                                        [收起] │
│  ───────────────────────────────────────────────────────────────────────── │
│                                                                             │
│  ┌─────────────────────────────────┬───────────────────────────────────────┐│
│  │  ETF 自身数据                   │  持仓成分股数据                        ││
│  │  ───────────────────────────── │  ───────────────────────────────────  ││
│  │                                 │                                       ││
│  │  Finviz:  ✅ 2024-01-15        │  持仓总数: 70                          ││
│  │  M.Cham:  ✅ 2024-01-15        │  已导入 Finviz: 65 / 70               ││
│  │  IBKR:    ✅ 14:32:05          │  已导入 M.Cham: 60 / 70               ││
│  │  Futu:    ✅ 14:32:08          │                                       ││
│  │                                 │  Top N 配置: [20 ▼]                   ││
│  │  ┌───────────────────────────┐ │  Top 20 覆盖权重: 82.3%               ││
│  │  │ 相对动量:  +3.2% (85分)   │ │                                       ││
│  │  │ 趋势质量:  上升通道 (78分)│ │  ┌───────────────────────────────────┐││
│  │  │ IVR:       45 (中性)      │ │  │ Top 20 数据完备度                 │││
│  │  │ P/C Ratio: 0.85 (偏多)    │ │  │ ██████████████░░░░░░  70%        │││
│  │  └───────────────────────────┘ │  │ Finviz: 20/20  MC: 18/20         │││
│  │                                 │  │ IBKR: 12/20    Futu: 8/20        │││
│  │  [刷新ETF自身数据]              │  └───────────────────────────────────┘││
│  │                                 │                                       ││
│  │                                 │  [获取缺失的 IBKR/Futu 数据]          ││
│  └─────────────────────────────────┴───────────────────────────────────────┘│
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  📊 持仓明细 (Top 20)                                                   ││
│  │  ───────────────────────────────────────────────────────────────────── ││
│  │  ┌──────┬────────┬───────┬───────┬───────┬───────┬──────────┬────────┐││
│  │  │Ticker│ 权重   │Finviz │M.Cham │ IBKR  │ Futu  │ 50MA状态 │ 期权热 │││
│  │  ├──────┼────────┼───────┼───────┼───────┼───────┼──────────┼────────┤││
│  │  │ AAPL │ 22.5%  │  ✅   │  ✅   │  ✅   │  ✅   │ > 50MA   │ 🟢趋势 │││
│  │  │ MSFT │ 20.1%  │  ✅   │  ✅   │  ✅   │  ❌   │ > 50MA   │ 🟡中性 │││
│  │  │ NVDA │ 15.3%  │  ✅   │  ✅   │  ❌   │  ❌   │ > 50MA   │ ⏳     │││
│  │  │ GOOGL│  8.2%  │  ✅   │  ❌   │  ❌   │  ❌   │ > 50MA   │ ⏳     │││
│  │  │ META │  6.1%  │  ✅   │  ❌   │  ❌   │  ❌   │ < 50MA   │ ⏳     │││
│  │  │ ...  │  ...   │  ...  │  ...  │  ...  │  ...  │  ...     │  ...   │││
│  │  └──────┴────────┴───────┴───────┴───────┴───────┴──────────┴────────┘││
│  │                                                                         ││
│  │  广度统计: 16/20 (80%) 在 50MA 上方 │ 14/20 (70%) 在 200MA 上方         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 完整的数据导入→触发流程

### 流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  用户操作                      系统响应                      触发动作       │
│  ─────────                    ─────────                    ─────────       │
│                                                                             │
│  ┌─────────────┐                                                            │
│  │导入 Finviz  │                                                            │
│  │数据 (JSON)  │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  系统识别数据类型                                                    │   │
│  │  ┌────────────────────┬────────────────────────────────────────────┐│   │
│  │  │ 类型               │ 识别规则                                   ││   │
│  │  ├────────────────────┼────────────────────────────────────────────┤│   │
│  │  │ ETF 自身数据       │ Ticker ∈ {SPY,QQQ,XLK,SOXX,...}           ││   │
│  │  │ ETF 持仓成分股数据 │ etf_symbol 指定 + Ticker 是个股           ││   │
│  │  └────────────────────┴────────────────────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ├─────────────────────────────────┐                                 │
│         ▼                                 ▼                                 │
│  ┌─────────────────────┐          ┌─────────────────────┐                  │
│  │ 是 ETF 自身数据     │          │ 是 ETF 持仓数据     │                  │
│  └──────────┬──────────┘          └──────────┬──────────┘                  │
│             │                                │                              │
│             ▼                                ▼                              │
│  ┌─────────────────────┐          ┌─────────────────────────────────────┐  │
│  │ 提示获取该ETF的     │          │ 分析 Top N 权重覆盖                  │  │
│  │ IBKR/Futu 实时数据  │          │ ├── Top 10: 58% (不足70%)           │  │
│  │                     │          │ ├── Top 15: 71% ✓                   │  │
│  │ [获取] [稍后]       │          │ └── Top 20: 82% ✓ (推荐)            │  │
│  └─────────┬───────────┘          │                                     │  │
│            │                      │ 提示获取 Top N 的 IBKR/Futu 数据    │  │
│            │                      │ [获取 Top 20] [自定义] [稍后]       │  │
│            │                      └──────────────────┬──────────────────┘  │
│            │                                         │                      │
│            └─────────────────┬───────────────────────┘                      │
│                              ▼                                              │
│                   ┌─────────────────────────────────┐                       │
│                   │ 批量调用 IBKR/Futu API          │                       │
│                   │ (带速率控制 + 进度显示)         │                       │
│                   └──────────────┬──────────────────┘                       │
│                                  ▼                                          │
│                   ┌─────────────────────────────────┐                       │
│                   │ 更新数据完备度                  │                       │
│                   │ 触发评分重算 (如果数据完备)     │                       │
│                   └─────────────────────────────────┘                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 评分计算的数据依赖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ETF 综合评分 = 0.55 × Price/RS + 0.20 × Breadth + 0.25 × Options          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Price/RS (55%) = 0.65 × RelMom + 0.35 × TrendQuality               │   │
│  │  ───────────────────────────────────────────────────────────────── │   │
│  │  数据来源: ETF 自身的 IBKR 数据 (历史K线计算)                        │   │
│  │  依赖: IBKR ✅                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Breadth (20%) = % above 50MA, % above 200MA                        │   │
│  │  ───────────────────────────────────────────────────────────────── │   │
│  │  数据来源: ETF 持仓成分股的 Finviz 数据 (SMA50, SMA200, Price)       │   │
│  │  依赖: 持仓 Finviz ✅                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Options (25%) = PositioningScore + TermScore + Heat                │   │
│  │  ───────────────────────────────────────────────────────────────── │   │
│  │  数据来源:                                                          │   │
│  │  ├── ETF 自身: MarketChameleon (IV30, IVR) + Futu (OI)             │   │
│  │  └── 持仓成分股: MarketChameleon (Put%, IV变化) + Futu (OI分布)     │   │
│  │  依赖: ETF MC ✅ + ETF Futu ✅ + 持仓 MC ✅ + 持仓 Futu ✅           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ⚠️ 最低可计算条件:                                                        │
│  ├── Price/RS: 需要 ETF 自身 IBKR 数据                                     │
│  ├── Breadth:  需要 持仓 Top N 的 Finviz 数据                              │
│  └── Options:  需要 ETF + 持仓 的 MC 数据 (Futu 可选增强)                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```



